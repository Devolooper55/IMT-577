CREATE VIEW VW_DIM_CUSTOMER AS
(
SELECT DIMCUSTOMERID, DIMLOCATIONID, CUSTOMERID, CUSTOMERFULLNAME, CUSTOMERFIRSTNAME, CUSTOMERLASTNAME, GENDER
FROM DIM_CUSTOMER  
);

CREATE VIEW VW_DIM_LOCATION AS
(
SELECT DIMLOCATIONID, ADDRESS, CITY, POSTALCODE, STATE_PROVINCE, COUNTRY
FROM DIM_LOCATION 
);

CREATE VIEW VW_DIM_PRODUCT AS
(
SELECT DIMPRODUCTID, SOURCEPRODUCTID, SOURCEPRODUCTTYPEID, SOURCEPRODUCTCATEGORYID, PRODUCTNAME, PRODUCTTYPE, PRODUCTCATEGORY,
  PRODUCTRETAILPRICE, PRODUCTWHOLEPRICE, PRODUCTCOST, PRODUCTRETAILPRODUCT, PRODUCTWHOLESALEUNITPROFIT,
  PRODUCTPROFITMARGINUNITPERCENTAGE
FROM DIM_PRODUCT
);

CREATE VIEW VW_DIM_RESELLER AS
(
SELECT DIMRESELLERID, DIMLOCATIONID, RESELLERID, RESELLERNAME, CONTACTNAME, PHONENUMBER, EMAIL
FROM DIM_RESELLER
);

CREATE VIEW VW_DIM_STORE AS
(
SELECT DIMSTOREID,DIMLOCATIONID, STOREID, STORENUMBER, STOREMANAGER
FROM DIM_STORE
);

CREATE VIEW VW_FACT_SALES AS
(
SELECT SOURCESALESHEADERID,SOURCESALESDETAILID, DIMPRODUCTID, DIMSTOREID, DIMRESELLERID, DIMCUSTOMERID, DIMCHANNELID, DIMSALEDATEID, DIMLOCATIONID,
  SALEAMOUNT, SALEQUANTITY, SALEUNITPRICE, SALEEXTENDEDCOST, SALETOTALPROFIT
FROM FACT_SALESACTUAL
);

CREATE VIEW VW_FACT_PRODUCT_TARGET AS
(
SELECT DIMPRODUCTID, DIMTARGETDATEID, PRODUCTTARGETSALESQUANTITY
FROM FACT_PRODUCTSALESTARGET
);

CREATE VIEW VW_FACT_SRC_TARGET AS
(
SELECT DIMCHANNELID, DIMSTOREID, DIMRESELLERID, DIMTARGETDATEID, SALESTARGETAMOUNT
FROM FACT_SRCSALESTARGET
);

---------------------------Question1 ---------------------------------

CREATE VIEW VW_STORE_PERFORMANCE_CUMMULATIVE AS
(
SELECT YEAR,MONTH_NAME,MONTH_NUM_IN_YEAR as MONTH_NUMBER, STORENUMBER,
SUM(ACT_AMT) OVER (PARTITION BY STORENUMBER ORDER BY MONTH_NUM_IN_YEAR ASC) AS ACT_CUMMULATIVE_SALE,
SUM(TARGET_AMT) OVER (PARTITION BY STORENUMBER ORDER BY MONTH_NUM_IN_YEAR ASC) AS TARGET_CUMMULATIVE_SALE
FROM
(
SELECT YEAR, MONTH_NAME, MONTH_NUM_IN_YEAR, STORENUMBER, SUM(TARGET_AMT) AS TARGET_AMT, SUM(ACT_AMT) AS ACT_AMT
FROM 
(
SELECT DD.Year,DD.MONTH_NAME, DD.MONTH_NUM_IN_YEAR, DS.STORENUMBER, SUM(FT.SALESTARGETAMOUNT) TARGET_AMT, 0 AS ACT_AMT
FROM FACT_SRCSALESTARGET FT
INNER JOIN DIM_STORE DS ON FT.DIMSTOREID = DS.DIMSTOREID
INNER JOIN DIM_DATE DD ON FT.DIMTARGETDATEID = DD.DATE_PKEY
WHERE YEAR = 2014 AND STORENUMBER in (10,21)
GROUP BY DD.Year,DD.MONTH_NAME, DD.MONTH_NUM_IN_YEAR, DS.STORENUMBER

UNION 

SELECT DD.Year, DD.MONTH_NAME, DD.MONTH_NUM_IN_YEAR,  DS.STORENUMBER, 0 AS TARGET_AMT, SUM(FS.SALEAMOUNT) AS ACT_AMT
FROM FACT_SALESACTUAL FS
INNER JOIN DIM_STORE DS ON FS.DIMSTOREID = DS.DIMSTOREID
INNER JOIN DIM_DATE DD ON FS.DIMSALEDATEID = DD.DATE_PKEY
WHERE YEAR = 2014 AND STORENUMBER in (10,21)
GROUP BY DD.Year, DD.MONTH_NAME, DD.MONTH_NUM_IN_YEAR, DS.STORENUMBER
)
GROUP BY YEAR, MONTH_NAME, MONTH_NUM_IN_YEAR, STORENUMBER
)
ORDER BY MONTH_NUM_IN_YEAR , STORENUMBER
);  

CREATE VIEW VW_STORE_PERFORMANCE AS
(
SELECT YEAR, MONTH_NAME, MONTH_NUM_IN_YEAR AS MONTH_NUMBER, STORENUMBER, SUM(TARGET_AMT) AS TARGET_AMT, SUM(ACT_AMT) AS ACT_AMT, 
ROUND((SUM(ACT_AMT)/SUM(TARGET_AMT))*100,2) AS PERCENT_TARGET_ACHIEVED
FROM 
(
SELECT DD.Year,DD.MONTH_NAME, DD.MONTH_NUM_IN_YEAR, DS.STORENUMBER, SUM(FT.SALESTARGETAMOUNT) TARGET_AMT, 0 AS ACT_AMT
FROM FACT_SRCSALESTARGET FT
INNER JOIN DIM_STORE DS ON FT.DIMSTOREID = DS.DIMSTOREID
INNER JOIN DIM_DATE DD ON FT.DIMTARGETDATEID = DD.DATE_PKEY
WHERE YEAR = 2014 AND STORENUMBER in (10,21)
GROUP BY DD.Year,DD.MONTH_NAME, DD.MONTH_NUM_IN_YEAR, DS.STORENUMBER

UNION 

SELECT DD.Year, DD.MONTH_NAME, DD.MONTH_NUM_IN_YEAR,  DS.STORENUMBER, 0 AS TARGET_AMT, SUM(FS.SALEAMOUNT) AS ACT_AMT
FROM FACT_SALESACTUAL FS
INNER JOIN DIM_STORE DS ON FS.DIMSTOREID = DS.DIMSTOREID
INNER JOIN DIM_DATE DD ON FS.DIMSALEDATEID = DD.DATE_PKEY
WHERE YEAR = 2014 AND STORENUMBER in (10,21)
GROUP BY DD.Year, DD.MONTH_NAME, DD.MONTH_NUM_IN_YEAR, DS.STORENUMBER
)
GROUP BY YEAR, MONTH_NAME, MONTH_NUM_IN_YEAR, STORENUMBER
ORDER BY YEAR,MONTH_NUM_IN_YEAR 
);

---------------------------Question 2 --------------------------------------

CREATE or REPLACE VIEW VW_BONUS_SHARE AS
(
SELECT YEAR, STORENUMBER,SALE,TARGET,
(SALE/TARGET) AS PROPOTION,
ROUND
(
CASE WHEN YEAR = 2013 THEN 200000*(SALE/TARGET)   
END,2) AS BONUS_PROPOTION
FROM
(
SELECT DD.Year, DS.STORENUMBER,
SUM(FS.SALEAMOUNT) AS SALE,
SUM(FT.SALESTARGETAMOUNT) AS TARGET
FROM FACT_SALESACTUAL FS
INNER JOIN DIM_STORE DS ON FS.DIMSTOREID = DS.DIMSTOREID
INNER JOIN DIM_PRODUCT DP ON FS.DIMPRODUCTID = DP.DIMPRODUCTID
INNER JOIN DIM_DATE DD ON FS.DIMSALEDATEID = DD.DATE_PKEY
INNER JOIN FACT_SRCSALESTARGET FT ON FS.DIMSTOREID = FT.DIMSTOREID
WHERE STORENUMBER IN (10,21) AND YEAR = 2013
AND DD.YEAR||DD.MONTH_NUM_IN_YEAR NOT IN (201411, 201312)  
GROUP BY DD.Year, DS.STORENUMBER
)
ORDER BY YEAR, STORENUMBER
);

---------------------------Question 3 --------------------------------------

CREATE OR REPLACE VIEW Q3 AS
(SELECT D.YEAR, FSA.DIMSTOREID, D.DAY_NAME, AVG(FSA.SALEAMOUNT) AS AVERAGE
FROM FACT_SALESACTUAL FSA
INNER JOIN DIM_STORE DS ON FSA.DIMSTOREID = DS.DIMSTOREID
INNER JOIN DIM_DATE D ON D.DATE_PKEY = FSA.DIMSALEDATEID
JOIN DIM_PRODUCT P ON P.DIMPRODUCTID = FSA.DIMPRODUCTID
WHERE (DS.DIMSTOREID = 6 OR DS.DIMSTOREID = 4) AND (FSA.DIMPRODUCTID >0 AND FSA.DIMSTOREID > 0)
GROUP BY D.YEAR, FSA.DIMSTOREID, D.DAY_NAME
ORDER BY D.YEAR, FSA.DIMSTOREID, AVERAGE DESC);

---------------------------Question 4 --------------------------------------
CREATE VIEW Q4 AS (
SELECT DD.DATE, DD.DAY_NAME,DD.YEAR, DD.MONTH_NAME, DL.STATE_PROVINCE, X.STORE_COUNT,DP.PRODUCTNAME, DP.PRODUCTTYPE, DP.PRODUCTCATEGORY,
SUM(FS.SALEQUANTITY) AS Total_SaleQuantity, SUM(FS.SALEAMOUNT) AS Total_SaleAmount, SUM(FS.SALETOTALPROFIT) AS Total_SaleProfit
FROM FACT_SALESACTUAL FS
INNER JOIN DIM_STORE DS ON FS.DIMSTOREID = DS.DIMSTOREID
INNER JOIN DIM_LOCATION DL ON DS.DIMLOCATIONID = DL.DIMLOCATIONID
INNER JOIN DIM_DATE DD ON FS.DIMSALEDATEID = DD.DATE_PKEY
INNER JOIN DIM_PRODUCT DP ON FS.DIMPRODUCTID = DP.DIMPRODUCTID
INNER JOIN
(
SELECT DL.STATE_PROVINCE, COUNT(DS.STORENUMBER) STORE_COUNT
FROM DIM_STORE DS
INNER JOIN DIM_LOCATION DL ON DS.DIMLOCATIONID = DL.DIMLOCATIONID
WHERE DL.STATE_PROVINCE <> 'Unknown'
GROUP BY DL.STATE_PROVINCE
) X
ON DL.STATE_PROVINCE = X.STATE_PROVINCE
WHERE DL.STATE_PROVINCE <> 'Unknown'
GROUP BY DD.DATE, DD.DAY_NAME, DD.YEAR, DD.MONTH_NAME, DL.STATE_PROVINCE, X.STORE_COUNT, DP.PRODUCTNAME, DP.PRODUCTTYPE, DP.PRODUcTCATEGORY
);
